
<!DOCTYPE html>

<html lang="zh_CN">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>samoyed.core &#8212; samoyed  文档</title>
    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/alabaster.css" />
    <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
    <script src="../../_static/jquery.js"></script>
    <script src="../../_static/underscore.js"></script>
    <script src="../../_static/doctools.js"></script>
    <script src="../../_static/translations.js"></script>
    <link rel="index" title="索引" href="../../genindex.html" />
    <link rel="search" title="搜索" href="../../search.html" />
   
  <link rel="stylesheet" href="../../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <h1>samoyed.core 源代码</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">from</span> <span class="nn">functools</span> <span class="kn">import</span> <span class="n">partial</span>
<span class="kn">from</span> <span class="nn">functools</span> <span class="kn">import</span> <span class="n">reduce</span>
<span class="kn">from</span> <span class="nn">numbers</span> <span class="kn">import</span> <span class="n">Number</span>
<span class="kn">from</span> <span class="nn">operator</span> <span class="kn">import</span> <span class="n">lt</span><span class="p">,</span> <span class="n">le</span><span class="p">,</span> <span class="n">eq</span><span class="p">,</span> <span class="n">ne</span><span class="p">,</span> <span class="n">ge</span><span class="p">,</span> <span class="n">gt</span><span class="p">,</span> <span class="n">not_</span><span class="p">,</span> <span class="n">or_</span><span class="p">,</span> <span class="n">and_</span> \
    <span class="p">,</span> <span class="n">sub</span><span class="p">,</span> <span class="n">mul</span><span class="p">,</span> <span class="n">mod</span><span class="p">,</span> <span class="n">truediv</span><span class="p">,</span> <span class="n">floordiv</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Union</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">,</span> <span class="n">Dict</span>

<span class="kn">import</span> <span class="nn">lark</span>
<span class="kn">from</span> <span class="nn">lark</span> <span class="kn">import</span> <span class="n">Lark</span><span class="p">,</span> <span class="n">Transformer</span>
<span class="kn">from</span> <span class="nn">lark.exceptions</span> <span class="kn">import</span> <span class="n">UnexpectedToken</span><span class="p">,</span> <span class="n">UnexpectedCharacters</span>
<span class="kn">from</span> <span class="nn">lark.indenter</span> <span class="kn">import</span> <span class="n">Indenter</span>

<span class="kn">from</span> <span class="nn">.exception</span> <span class="kn">import</span> <span class="n">SamoyedTypeError</span><span class="p">,</span> <span class="n">SamoyedInterpretError</span><span class="p">,</span> <span class="n">NotFoundEntrance</span><span class="p">,</span> \
    <span class="n">SamoyedNameError</span><span class="p">,</span> <span class="n">NotImplementError</span><span class="p">,</span> <span class="n">SamoyedRuntimeError</span>
<span class="kn">from</span> <span class="nn">.libs</span> <span class="kn">import</span> <span class="n">TimeControl</span><span class="p">,</span> <span class="n">arg_seq_add</span><span class="p">,</span> <span class="n">arg_option_add</span><span class="p">,</span> <span class="n">mock_add</span>

<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">解释器核心</span>
<span class="sd">&quot;&quot;&quot;</span>


<div class="viewcode-block" id="SamoyedIndenter"><a class="viewcode-back" href="../../source/samoyed.html#samoyed.core.SamoyedIndenter">[文档]</a><span class="k">class</span> <span class="nc">SamoyedIndenter</span><span class="p">(</span><span class="n">Indenter</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    间隔控制</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">NL_type</span> <span class="o">=</span> <span class="s1">&#39;_NEWLINE&#39;</span>
    <span class="n">OPEN_PAREN_types</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">CLOSE_PAREN_types</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">INDENT_type</span> <span class="o">=</span> <span class="s1">&#39;_INDENT&#39;</span>
    <span class="n">DEDENT_type</span> <span class="o">=</span> <span class="s1">&#39;_DEDENT&#39;</span>
    <span class="n">tab_len</span> <span class="o">=</span> <span class="mi">8</span></div>


<div class="viewcode-block" id="SamoyedTransformer"><a class="viewcode-back" href="../../source/samoyed.html#samoyed.core.SamoyedTransformer">[文档]</a><span class="k">class</span> <span class="nc">SamoyedTransformer</span><span class="p">(</span><span class="n">Transformer</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    基础的语法制导，只会转换一些常量。</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">none</span> <span class="o">=</span> <span class="k">lambda</span> <span class="bp">self</span><span class="p">,</span> <span class="n">_</span><span class="p">:</span> <span class="kc">None</span>
    <span class="n">true</span> <span class="o">=</span> <span class="k">lambda</span> <span class="bp">self</span><span class="p">,</span> <span class="n">_</span><span class="p">:</span> <span class="kc">True</span>
    <span class="n">false</span> <span class="o">=</span> <span class="k">lambda</span> <span class="bp">self</span><span class="p">,</span> <span class="n">_</span><span class="p">:</span> <span class="kc">False</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dollar</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>  <span class="c1"># type: set[str]</span>

<div class="viewcode-block" id="SamoyedTransformer.FLOAT"><a class="viewcode-back" href="../../source/samoyed.html#samoyed.core.SamoyedTransformer.FLOAT">[文档]</a>    <span class="k">def</span> <span class="nf">FLOAT</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="n">lark</span><span class="o">.</span><span class="n">Token</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
        <span class="k">return</span> <span class="nb">float</span><span class="p">(</span><span class="n">value</span><span class="p">)</span></div>

<div class="viewcode-block" id="SamoyedTransformer.INT"><a class="viewcode-back" href="../../source/samoyed.html#samoyed.core.SamoyedTransformer.INT">[文档]</a>    <span class="k">def</span> <span class="nf">INT</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="n">lark</span><span class="o">.</span><span class="n">Token</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">value</span><span class="p">)</span></div>

<div class="viewcode-block" id="SamoyedTransformer.STR"><a class="viewcode-back" href="../../source/samoyed.html#samoyed.core.SamoyedTransformer.STR">[文档]</a>    <span class="k">def</span> <span class="nf">STR</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="n">lark</span><span class="o">.</span><span class="n">Token</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">3</span> <span class="ow">and</span> <span class="n">value</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="n">value</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;</span><span class="se">\&quot;</span><span class="s2">&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">value</span><span class="p">[</span><span class="mi">3</span><span class="p">:</span><span class="o">-</span><span class="mi">3</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">value</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span></div>

<div class="viewcode-block" id="SamoyedTransformer.DOLLAR_VAR"><a class="viewcode-back" href="../../source/samoyed.html#samoyed.core.SamoyedTransformer.DOLLAR_VAR">[文档]</a>    <span class="k">def</span> <span class="nf">DOLLAR_VAR</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="n">lark</span><span class="o">.</span><span class="n">Token</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dollar</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">value</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">value</span></div></div>


<div class="viewcode-block" id="Context"><a class="viewcode-back" href="../../source/samoyed.html#samoyed.core.Context">[文档]</a><span class="k">class</span> <span class="nc">Context</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    上下文</span>
<span class="sd">    包括</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">names</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">dollar_names</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Notes</span>
<span class="sd">        ---------</span>
<span class="sd">            如果dollar_names包含名字叫mg的方法会被过滤掉</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        names</span>
<span class="sd">            外部传入的变量表</span>
<span class="sd">        dollar_names</span>
<span class="sd">            传入的参数</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">names</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">names</span><span class="p">)</span> <span class="k">if</span> <span class="n">names</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">seq_args</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">option_args</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># 给外部传入的属性加上$</span>
        <span class="k">if</span> <span class="n">dollar_names</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">dollar_names</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">key</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;mg&quot;</span><span class="p">):</span> <span class="k">continue</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">names</span><span class="p">[</span><span class="s2">&quot;$&quot;</span> <span class="o">+</span> <span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">dollar_names</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>

        <span class="c1"># 绑定内置函数</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">names</span><span class="p">[</span><span class="s2">&quot;print&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">print</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">names</span><span class="p">[</span><span class="s2">&quot;speak&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">print</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">names</span><span class="p">[</span><span class="s2">&quot;listen&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">input</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">names</span><span class="p">[</span><span class="s2">&quot;exit&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">set_exit</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">names</span><span class="p">[</span><span class="s2">&quot;arg_seq_add&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">partial</span><span class="p">(</span><span class="n">arg_seq_add</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">seq_args</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">names</span><span class="p">[</span><span class="s2">&quot;arg_option_add&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">partial</span><span class="p">(</span><span class="n">arg_option_add</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">option_args</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stage</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># type:lark.tree.Tree</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">next</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># type:lark.tree.Tree</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">__exit</span> <span class="o">=</span> <span class="kc">False</span>

<div class="viewcode-block" id="Context.is_exit"><a class="viewcode-back" href="../../source/samoyed.html#samoyed.core.Context.is_exit">[文档]</a>    <span class="k">def</span> <span class="nf">is_exit</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="o">-&gt;</span><span class="nb">bool</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        判断当前程序是否已经退出</span>
<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        bool</span>
<span class="sd">            当前程序是否已经退出</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__exit</span></div>

<div class="viewcode-block" id="Context.set_exit"><a class="viewcode-back" href="../../source/samoyed.html#samoyed.core.Context.set_exit">[文档]</a>    <span class="k">def</span> <span class="nf">set_exit</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        设置当前程序退出</span>
<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__exit</span> <span class="o">=</span> <span class="kc">True</span></div></div>


<div class="viewcode-block" id="Interpreter"><a class="viewcode-back" href="../../source/samoyed.html#samoyed.core.Interpreter">[文档]</a><span class="k">class</span> <span class="nc">Interpreter</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;解释器</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># 语法制导。用于构件AST时转换一些常量</span>
    <span class="n">transformer</span> <span class="o">=</span> <span class="n">SamoyedTransformer</span><span class="p">()</span>

    <span class="c1"># 读取文法</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2">/samoyed.gram&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="vm">__file__</span><span class="p">))))</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">parser</span> <span class="o">=</span> <span class="n">Lark</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">(),</span> <span class="n">parser</span><span class="o">=</span><span class="s1">&#39;lalr&#39;</span><span class="p">,</span> <span class="n">postlex</span><span class="o">=</span><span class="n">SamoyedIndenter</span><span class="p">(),</span> <span class="n">transformer</span><span class="o">=</span><span class="n">transformer</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">code</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">lark</span><span class="o">.</span><span class="n">Tree</span><span class="p">],</span> <span class="n">context</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">args</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">dont_init</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        code</span>
<span class="sd">        context</span>
<span class="sd">        args</span>
<span class="sd">        dont_init</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__isinit</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="c1"># 词法和语法分析</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">code</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">ast</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parser</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">code</span><span class="p">)</span>  <span class="c1"># type:lark.tree.Tree</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">dollar_symbol</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">transformer</span><span class="o">.</span><span class="n">dollar</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="k">except</span> <span class="n">UnexpectedToken</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">SamoyedInterpretError</span><span class="p">()</span>
            <span class="k">except</span> <span class="n">UnexpectedCharacters</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">SamoyedInterpretError</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ast</span> <span class="o">=</span> <span class="n">code</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">context</span> <span class="o">=</span> <span class="n">Context</span><span class="p">(</span><span class="n">names</span><span class="o">=</span><span class="n">context</span><span class="p">,</span> <span class="n">dollar_names</span><span class="o">=</span><span class="n">args</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">dont_init</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">init</span><span class="p">()</span>

<div class="viewcode-block" id="Interpreter.init"><a class="viewcode-back" href="../../source/samoyed.html#samoyed.core.Interpreter.init">[文档]</a>    <span class="k">def</span> <span class="nf">init</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stage</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">entrance</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="c1"># 遍历AST的顶层，确定所有的stage和入口</span>
        <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">ast</span><span class="o">.</span><span class="n">children</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">data</span> <span class="o">==</span> <span class="s1">&#39;statedef&#39;</span><span class="p">:</span>
                <span class="c1"># 如果是状态定义</span>
                <span class="c1"># 第一个子节点是名称</span>
                <span class="n">name</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">children</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">name</span> <span class="o">==</span> <span class="s2">&quot;main&quot;</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">entrance</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stage</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">node</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">stage</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">node</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">exec_statement</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">entrance</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">NotFoundEntrance</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">stage</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">entrance</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__isinit</span> <span class="o">=</span> <span class="kc">True</span></div>

<div class="viewcode-block" id="Interpreter.exec"><a class="viewcode-back" href="../../source/samoyed.html#samoyed.core.Interpreter.exec">[文档]</a>    <span class="k">def</span> <span class="nf">exec</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        执行</span>
<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">__isinit</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">stat</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">stage</span><span class="o">.</span><span class="n">children</span><span class="p">[</span><span class="mi">1</span><span class="p">:]:</span>
                <span class="c1"># 遍历并执行每个状态中的语句</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">exec_statement</span><span class="p">(</span><span class="n">stat</span><span class="p">)</span>
                <span class="c1"># 如果调用了exit，直接退出</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">is_exit</span><span class="p">():</span>
                    <span class="k">return</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">next</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="c1"># 如果未指定下一个状态，那么结束</span>
                <span class="k">return</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">stage</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">next</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">next</span> <span class="o">=</span> <span class="kc">None</span></div>

<div class="viewcode-block" id="Interpreter.exec_statement"><a class="viewcode-back" href="../../source/samoyed.html#samoyed.core.Interpreter.exec_statement">[文档]</a>    <span class="k">def</span> <span class="nf">exec_statement</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">stat</span><span class="p">:</span> <span class="n">lark</span><span class="o">.</span><span class="n">tree</span><span class="o">.</span><span class="n">Tree</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        执行每一个语句</span>
<span class="sd">        :param stat: 语句语法节点</span>
<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">stat</span><span class="o">.</span><span class="n">data</span> <span class="o">==</span> <span class="s2">&quot;simple_stmt&quot;</span><span class="p">:</span>
            <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            如果是一个简单的表达式</span>
<span class="sd">            simple_stmt包括：</span>
<span class="sd">            * pass_expr 什么也不做.</span>
<span class="sd">            * branch_expr 跳转表达式</span>
<span class="sd">            * _full_expr 一个普通表达式，如果这个表达式非过程，那么它是无副作用的</span>
<span class="sd">            * assign_expr 赋值表达式</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="n">simple_stmt</span> <span class="o">=</span> <span class="n">stat</span><span class="o">.</span><span class="n">children</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">simple_stmt_type</span> <span class="o">=</span> <span class="n">simple_stmt</span><span class="o">.</span><span class="n">data</span>
            <span class="k">if</span> <span class="n">simple_stmt_type</span> <span class="o">==</span> <span class="s2">&quot;branch_expr&quot;</span><span class="p">:</span>
                <span class="c1"># 是一个跳转语句</span>
                <span class="n">next_state</span> <span class="o">=</span> <span class="n">simple_stmt</span><span class="o">.</span><span class="n">children</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">next_state</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">stage</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">next</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stage</span><span class="p">[</span><span class="n">next_state</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">SamoyedNameError</span>

            <span class="k">elif</span> <span class="n">simple_stmt_type</span> <span class="o">==</span> <span class="s2">&quot;assign_expr&quot;</span><span class="p">:</span>
                <span class="c1"># 是一个赋值语句</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">names</span><span class="p">[</span><span class="n">simple_stmt</span><span class="o">.</span><span class="n">children</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_expression</span><span class="p">(</span><span class="n">simple_stmt</span><span class="o">.</span><span class="n">children</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
            <span class="k">elif</span> <span class="n">simple_stmt_type</span> <span class="o">==</span> <span class="s2">&quot;pass_expr&quot;</span><span class="p">:</span>
                <span class="k">return</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># 是一个表达式</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">get_expression</span><span class="p">(</span><span class="n">stat</span><span class="o">.</span><span class="n">children</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="k">elif</span> <span class="n">stat</span><span class="o">.</span><span class="n">data</span> <span class="o">==</span> <span class="s2">&quot;match_stmt&quot;</span><span class="p">:</span>
            <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            match字句有两种形式</span>
<span class="sd">            第一种形式是带有时间控制的匹配</span>
<span class="sd">            其中，@的第一个参数是超时时间，必选；第二个参数是最少持续时间，可选；</span>
<span class="sd">            @后应该接入一个函数调用。延时表达式会不断调用这个函数</span>
<span class="sd">            match @(10,2)funcall :</span>
<span class="sd">                compare_expr =&gt;</span>
<span class="sd">                    stat</span>
<span class="sd">                ...</span>
<span class="sd">                slience =&gt;</span>
<span class="sd">                    stat</span>
<span class="sd">            第二种形式是普通的多值匹配</span>
<span class="sd">            match expr :</span>
<span class="sd">                compare_expr =&gt;</span>
<span class="sd">                    stat</span>
<span class="sd">                compare_expr =&gt;</span>
<span class="sd">                    stat</span>
<span class="sd">                default =&gt;</span>
<span class="sd">                    stat</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="n">expr</span> <span class="o">=</span> <span class="n">stat</span><span class="o">.</span><span class="n">children</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>  <span class="c1"># expr</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">expr</span><span class="p">,</span> <span class="n">lark</span><span class="o">.</span><span class="n">tree</span><span class="o">.</span><span class="n">Tree</span><span class="p">)</span> <span class="ow">and</span> <span class="n">expr</span><span class="o">.</span><span class="n">data</span> <span class="o">==</span> <span class="s2">&quot;at_expr&quot;</span><span class="p">:</span>
                <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">                如果是限定时间的语句...</span>
<span class="sd">                会尝试一直读取值，直到超时或者匹配成功</span>
<span class="sd">                &quot;&quot;&quot;</span>
                <span class="c1"># 获取函数</span>
                <span class="n">_context</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">names</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">func</span> <span class="o">:=</span> <span class="n">_context</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">expr</span><span class="o">.</span><span class="n">children</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="kc">None</span><span class="p">))</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">callable</span><span class="p">(</span><span class="n">func</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">expr</span><span class="o">.</span><span class="n">children</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="c1"># 如果有参数</span>
                        <span class="k">assert</span> <span class="n">expr</span><span class="o">.</span><span class="n">children</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">expr</span><span class="o">.</span><span class="n">children</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                        <span class="n">func</span> <span class="o">=</span> <span class="n">partial</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="o">*</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">get_expression</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">expr</span><span class="o">.</span><span class="n">children</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">children</span><span class="p">])</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">SamoyedNameError</span><span class="p">(</span><span class="s2">&quot;No such function&quot;</span><span class="p">)</span>

                <span class="c1"># 构造一个TimeControl对象。将这个函数传入构造</span>
                <span class="n">control</span> <span class="o">=</span> <span class="n">TimeControl</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="o">*</span><span class="n">expr</span><span class="o">.</span><span class="n">children</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">children</span><span class="p">)</span>
                <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># 每次读取的值</span>
                <span class="c1"># 预先算出每个case的表达式，不包含silence字句</span>
                <span class="n">cases</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">get_expression</span><span class="p">(</span><span class="n">case_statment</span><span class="o">.</span><span class="n">children</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="k">for</span> <span class="n">case_statment</span> <span class="ow">in</span> <span class="n">stat</span><span class="o">.</span><span class="n">children</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="k">if</span>
                         <span class="n">case_statment</span><span class="o">.</span><span class="n">data</span> <span class="o">!=</span> <span class="s2">&quot;slience_stmt&quot;</span><span class="p">]</span>
                <span class="n">find_flag</span> <span class="o">=</span> <span class="kc">False</span>  <span class="c1"># 是否完成匹配</span>
                <span class="n">finded_case</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># 匹配的是第几个</span>

                <span class="c1"># 遍历生成器</span>
                <span class="c1"># 如果超时，生成式结束</span>
                <span class="k">for</span> <span class="n">result</span> <span class="ow">in</span> <span class="n">control</span><span class="p">():</span>
                    <span class="c1"># 保存每次结果</span>
                    <span class="k">if</span> <span class="n">result</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
                    <span class="c1"># 如果结果出现在case字句中，那么跳出</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">control</span><span class="o">.</span><span class="n">can_exit</span><span class="o">.</span><span class="n">is_set</span><span class="p">():</span> <span class="k">continue</span>
                    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">case</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">cases</span><span class="p">):</span>
                        <span class="n">concat_result</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">results</span><span class="p">)</span>
                        <span class="n">is_matched</span><span class="p">,</span> <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_match_value</span><span class="p">(</span><span class="n">concat_result</span><span class="p">,</span> <span class="n">case</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">is_matched</span><span class="p">:</span>
                            <span class="n">find_flag</span> <span class="o">=</span> <span class="kc">True</span>
                            <span class="n">finded_case</span> <span class="o">=</span> <span class="n">i</span>
                            <span class="n">control</span><span class="o">.</span><span class="n">cancel</span><span class="p">()</span>
                            <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">                            保存匹配的变量</span>
<span class="sd">                            &quot;&quot;&quot;</span>
                            <span class="k">if</span> <span class="n">result</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">names</span><span class="p">[</span><span class="s2">&quot;$mg0&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">group</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">groups</span><span class="p">()):</span>
                                    <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">names</span><span class="p">[</span><span class="s2">&quot;$mg</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)]</span> <span class="o">=</span> <span class="n">group</span>
                            <span class="k">break</span>
                    <span class="c1"># 如果匹配，那么执行这个子块</span>
                    <span class="k">if</span> <span class="n">find_flag</span> <span class="ow">and</span> <span class="n">control</span><span class="o">.</span><span class="n">can_exit</span><span class="o">.</span><span class="n">is_set</span><span class="p">():</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">exec_statement</span><span class="p">(</span><span class="n">stat</span><span class="o">.</span><span class="n">children</span><span class="p">[</span><span class="n">finded_case</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">children</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                        <span class="k">return</span>
                <span class="c1"># 没有完成任何匹配</span>
                <span class="c1"># 如果有slience块，执行slience块</span>
                <span class="k">if</span> <span class="n">stat</span><span class="o">.</span><span class="n">children</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">data</span> <span class="o">==</span> <span class="s2">&quot;slience_stmt&quot;</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">st</span> <span class="ow">in</span> <span class="n">stat</span><span class="o">.</span><span class="n">children</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">children</span><span class="p">:</span>
                        <span class="c1"># 执行块中的每个语句</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">exec_statement</span><span class="p">(</span><span class="n">st</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">expr_result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_expression</span><span class="p">(</span><span class="n">expr</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">case_statment</span> <span class="ow">in</span> <span class="n">stat</span><span class="o">.</span><span class="n">children</span><span class="p">[</span><span class="mi">1</span><span class="p">:]:</span>  <span class="c1"># stat.children[0]是bool表达式</span>
                    <span class="k">if</span> <span class="n">case_statment</span><span class="o">.</span><span class="n">data</span> <span class="o">==</span> <span class="s2">&quot;default_stmt&quot;</span><span class="p">:</span>
                        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">                        如果是默认情况，直接执行这个语句</span>
<span class="sd">                        parser保证默认情况在最后面</span>
<span class="sd">                        &quot;&quot;&quot;</span>
                        <span class="k">for</span> <span class="n">st</span> <span class="ow">in</span> <span class="n">case_statment</span><span class="o">.</span><span class="n">children</span><span class="p">:</span>
                            <span class="c1"># 执行块中的每个语句</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">exec_statement</span><span class="p">(</span><span class="n">st</span><span class="p">)</span>
                        <span class="k">break</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">                        否则，判断值相同才执行</span>
<span class="sd">                        字符串只要包含子串就会执行                        </span>
<span class="sd">                        &quot;&quot;&quot;</span>
                        <span class="n">matching_value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_expression</span><span class="p">(</span><span class="n">case_statment</span><span class="o">.</span><span class="n">children</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                        <span class="n">is_matched</span><span class="p">,</span> <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_match_value</span><span class="p">(</span><span class="n">matching_value</span><span class="p">,</span> <span class="n">expr_result</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">is_matched</span><span class="p">:</span>
                            <span class="k">if</span> <span class="n">result</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">names</span><span class="p">[</span><span class="s2">&quot;$mg0&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">group</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">groups</span><span class="p">()):</span>
                                    <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">names</span><span class="p">[</span><span class="s2">&quot;$mg</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)]</span> <span class="o">=</span> <span class="n">group</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">exec_statement</span><span class="p">(</span><span class="n">case_statment</span><span class="o">.</span><span class="n">children</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="k">elif</span> <span class="n">stat</span><span class="o">.</span><span class="n">data</span> <span class="o">==</span> <span class="s2">&quot;if_stmt&quot;</span><span class="p">:</span>
            <span class="n">bool_expr</span> <span class="o">=</span> <span class="n">stat</span><span class="o">.</span><span class="n">children</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">bool_expr</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">exec_statement</span><span class="p">(</span><span class="n">stat</span><span class="o">.</span><span class="n">children</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">exec_statement</span><span class="p">(</span><span class="n">stat</span><span class="o">.</span><span class="n">children</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">NotImplementError</span></div>

<div class="viewcode-block" id="Interpreter.get_expression"><a class="viewcode-back" href="../../source/samoyed.html#samoyed.core.Interpreter.get_expression">[文档]</a>    <span class="k">def</span> <span class="nf">get_expression</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">expr</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">lark</span><span class="o">.</span><span class="n">tree</span><span class="o">.</span><span class="n">Tree</span><span class="p">,</span> <span class="n">lark</span><span class="o">.</span><span class="n">lexer</span><span class="o">.</span><span class="n">Token</span><span class="p">,</span> <span class="n">Number</span><span class="p">,</span> <span class="nb">str</span><span class="p">],</span>
                       <span class="n">dont_compute</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> \
            <span class="o">-&gt;</span> <span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="nb">bool</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="nb">type</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="n">x</span> <span class="o">+</span> <span class="n">y</span><span class="p">)]:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        获取表达式的值</span>
<span class="sd">        :param expr: 表达式树</span>
<span class="sd">        :param context: 上下文,默认为None.如果传入上下文，那么按照上下文计算表达式的值</span>
<span class="sd">        :return: 数字，字符串或者函数</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">expr</span><span class="p">,</span> <span class="n">lark</span><span class="o">.</span><span class="n">lexer</span><span class="o">.</span><span class="n">Token</span><span class="p">):</span>
            <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            如果是终结符</span>
<span class="sd">            有以下几种终结符表达式：</span>
<span class="sd">            * parentheses(不处理)</span>
<span class="sd">            * FLOAT(语法制导处理)</span>
<span class="sd">            * INT(语法制导处理)</span>
<span class="sd">            * STR(语法制导处理)</span>
<span class="sd">            * &quot;none&quot;(语法制导处理)</span>
<span class="sd">            * &quot;true&quot;(语法制导处理)</span>
<span class="sd">            * &quot;false&quot;(语法制导处理)</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="k">if</span> <span class="n">expr</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s2">&quot;STR&quot;</span> <span class="ow">or</span> <span class="n">expr</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s1">&#39;none&#39;</span> <span class="ow">or</span> \
                    <span class="n">expr</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s2">&quot;true&quot;</span> <span class="ow">or</span> <span class="n">expr</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s2">&quot;false&quot;</span> <span class="ow">or</span> \
                    <span class="n">expr</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s2">&quot;SIGNED_INT&quot;</span> <span class="ow">or</span> <span class="n">expr</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s2">&quot;SIGNED_FLOAT&quot;</span><span class="p">:</span>
                <span class="c1"># 如果是一些常量，直接返回</span>
                <span class="k">return</span> <span class="n">expr</span>
            <span class="k">elif</span> <span class="n">expr</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s2">&quot;NAME&quot;</span> <span class="ow">or</span> <span class="n">expr</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s2">&quot;DOLLAR_VAR&quot;</span><span class="p">:</span>
                <span class="n">_context</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">names</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">var</span> <span class="o">:=</span> <span class="n">_context</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">expr</span><span class="o">.</span><span class="n">value</span><span class="p">))</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">var</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">SamoyedNameError</span><span class="p">(</span><span class="s2">&quot;No such variable&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">SamoyedInterpretError</span><span class="p">(</span><span class="n">expr</span><span class="o">.</span><span class="n">type</span><span class="p">,</span> <span class="n">pos</span><span class="o">=</span><span class="p">(</span><span class="n">expr</span><span class="o">.</span><span class="n">line</span><span class="p">,</span> <span class="n">expr</span><span class="o">.</span><span class="n">column</span><span class="p">))</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">expr</span><span class="p">,</span> <span class="n">Number</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">expr</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="ow">or</span> <span class="n">expr</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">expr</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">expr</span><span class="p">,</span> <span class="n">lark</span><span class="o">.</span><span class="n">tree</span><span class="o">.</span><span class="n">Tree</span><span class="p">):</span>
            <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            如果是非终结符</span>
<span class="sd">            有以下几种非终结符表达式：</span>
<span class="sd">            * conditional_expr: 三目表达式。</span>
<span class="sd">            * or_test: 子句之间做逻辑或运算</span>
<span class="sd">            * and_test: 子句之间做逻辑与运算</span>
<span class="sd">            * not_test: 子句之间做逻辑非运算</span>
<span class="sd">            * compare_expr: 两个子句之间根据逻辑运算符做比较。</span>
<span class="sd">            * plus_expr: 子句之间根据加减符号运算</span>
<span class="sd">            * mul_expr： 子句之间根据乘除等符号做运算</span>
<span class="sd">            * factor：正负号</span>
<span class="sd">            * NAME：从符号表中取变量</span>
<span class="sd">            * funccall：从符号表中取变量</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="k">if</span> <span class="n">expr</span><span class="o">.</span><span class="n">data</span> <span class="o">==</span> <span class="s1">&#39;add_op&#39;</span> <span class="ow">or</span> <span class="n">expr</span><span class="o">.</span><span class="n">data</span> <span class="o">==</span> <span class="s2">&quot;mul_op&quot;</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">arith_operator</span><span class="p">[</span><span class="n">expr</span><span class="o">.</span><span class="n">children</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
            <span class="k">elif</span> <span class="n">expr</span><span class="o">.</span><span class="n">data</span> <span class="o">==</span> <span class="s2">&quot;conditional_expr&quot;</span><span class="p">:</span>
                <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">                conditional_expr : bool_expr?first:second</span>
<span class="sd">                bool_expr = expr.children[0]</span>
<span class="sd">                &quot;&quot;&quot;</span>
                <span class="n">bool_expr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_expression</span><span class="p">(</span><span class="n">expr</span><span class="o">.</span><span class="n">children</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                <span class="k">if</span> <span class="n">bool_expr</span><span class="p">:</span>
                    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_expression</span><span class="p">(</span><span class="n">expr</span><span class="o">.</span><span class="n">children</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_expression</span><span class="p">(</span><span class="n">expr</span><span class="o">.</span><span class="n">children</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
            <span class="k">elif</span> <span class="n">expr</span><span class="o">.</span><span class="n">data</span> <span class="o">==</span> <span class="s2">&quot;compare_expr&quot;</span><span class="p">:</span>
                <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">                compare_expr : left compare_expr right</span>
<span class="sd">                compare_operator : expr.children[1].children[0]</span>
<span class="sd">                left = expr.children[0]</span>
<span class="sd">                right = expr.children[2]</span>
<span class="sd">                &quot;&quot;&quot;</span>
                <span class="n">left</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_expression</span><span class="p">(</span><span class="n">expr</span><span class="o">.</span><span class="n">children</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                <span class="n">right</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_expression</span><span class="p">(</span><span class="n">expr</span><span class="o">.</span><span class="n">children</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
                <span class="n">op</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compare_operator</span><span class="p">[</span><span class="n">expr</span><span class="o">.</span><span class="n">children</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">children</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>

                <span class="k">try</span><span class="p">:</span>
                    <span class="c1"># 两种类型可能不能比较</span>
                    <span class="n">result</span> <span class="o">=</span> <span class="n">op</span><span class="p">(</span><span class="n">left</span><span class="p">,</span> <span class="n">right</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="k">raise</span>
                <span class="k">return</span> <span class="n">result</span>
            <span class="k">elif</span> <span class="n">expr</span><span class="o">.</span><span class="n">data</span> <span class="o">==</span> <span class="s2">&quot;not_test&quot;</span><span class="p">:</span>
                <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">                not_test : &quot;not&quot; test_expr</span>
<span class="sd">                test_expr = expr.children[0]</span>
<span class="sd">                &quot;&quot;&quot;</span>
                <span class="k">return</span> <span class="nb">bool</span><span class="p">(</span><span class="n">not_</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_expression</span><span class="p">(</span><span class="n">expr</span><span class="o">.</span><span class="n">children</span><span class="p">[</span><span class="mi">0</span><span class="p">])))</span>
            <span class="k">elif</span> <span class="n">expr</span><span class="o">.</span><span class="n">data</span> <span class="o">==</span> <span class="s2">&quot;or_test&quot;</span><span class="p">:</span>
                <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">                or_test : expr1 &quot;or&quot; expr2 &quot;or&quot; expr3 &quot;or&quot; ....</span>
<span class="sd">                expr1 = expr.children[0]</span>
<span class="sd">                expr2 = expr.children[1]</span>
<span class="sd">                ...</span>
<span class="sd">                &quot;&quot;&quot;</span>
                <span class="k">return</span> <span class="nb">bool</span><span class="p">(</span><span class="n">reduce</span><span class="p">(</span><span class="n">or_</span><span class="p">,</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">get_expression</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">expr</span><span class="o">.</span><span class="n">children</span><span class="p">]))</span>
            <span class="k">elif</span> <span class="n">expr</span><span class="o">.</span><span class="n">data</span> <span class="o">==</span> <span class="s2">&quot;and_test&quot;</span><span class="p">:</span>
                <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">                and_test : expr1 &quot;and_&quot; expr2 &quot;and_&quot; expr3 &quot;and_&quot; ....</span>
<span class="sd">                expr1 = expr.children[0]</span>
<span class="sd">                expr2 = expr.children[1]</span>
<span class="sd">                ...</span>
<span class="sd">                &quot;&quot;&quot;</span>
                <span class="k">return</span> <span class="nb">bool</span><span class="p">(</span><span class="n">reduce</span><span class="p">(</span><span class="n">and_</span><span class="p">,</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">get_expression</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">expr</span><span class="o">.</span><span class="n">children</span><span class="p">]))</span>
            <span class="k">elif</span> <span class="n">expr</span><span class="o">.</span><span class="n">data</span> <span class="o">==</span> <span class="s2">&quot;plus_expr&quot;</span> <span class="ow">or</span> <span class="n">expr</span><span class="o">.</span><span class="n">data</span> <span class="o">==</span> <span class="s2">&quot;mul_expr&quot;</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">reduce</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">get_expression</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">expr</span><span class="o">.</span><span class="n">children</span><span class="p">])</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="k">raise</span>
                <span class="k">return</span> <span class="n">result</span>
            <span class="k">elif</span> <span class="n">expr</span><span class="o">.</span><span class="n">data</span> <span class="o">==</span> <span class="s2">&quot;factor&quot;</span><span class="p">:</span>
                <span class="n">tmp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_expression</span><span class="p">(</span><span class="n">expr</span><span class="o">.</span><span class="n">children</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                <span class="k">if</span> <span class="n">expr</span><span class="o">.</span><span class="n">children</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;-&#39;</span><span class="p">:</span>
                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                        <span class="k">raise</span> <span class="n">SamoyedTypeError</span>
                    <span class="k">return</span> <span class="o">-</span><span class="n">tmp</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">tmp</span>
            <span class="k">elif</span> <span class="n">expr</span><span class="o">.</span><span class="n">data</span> <span class="o">==</span> <span class="s2">&quot;funccall&quot;</span><span class="p">:</span>
                <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">                函数调用</span>
<span class="sd">                &quot;&quot;&quot;</span>
                <span class="n">_context</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">names</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">func</span> <span class="o">:=</span> <span class="n">_context</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">expr</span><span class="o">.</span><span class="n">children</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="kc">None</span><span class="p">))</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">callable</span><span class="p">(</span><span class="n">func</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">expr</span><span class="o">.</span><span class="n">children</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="c1"># 如果有参数</span>
                        <span class="k">return</span> <span class="n">func</span><span class="p">(</span><span class="o">*</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">get_expression</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">expr</span><span class="o">.</span><span class="n">children</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">children</span><span class="p">])</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">return</span> <span class="n">func</span><span class="p">()</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">SamoyedNameError</span><span class="p">(</span><span class="s2">&quot;No such function&quot;</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">expr</span><span class="o">.</span><span class="n">data</span> <span class="o">==</span> <span class="s2">&quot;reg&quot;</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">expr</span><span class="o">.</span><span class="n">children</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">NotImplementError</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">NotImplementError</span></div>

<div class="viewcode-block" id="Interpreter.reduce"><a class="viewcode-back" href="../../source/samoyed.html#samoyed.core.Interpreter.reduce">[文档]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">reduce</span><span class="p">(</span><span class="n">l</span><span class="p">:</span> <span class="nb">list</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        计算形如数值、函数混合列表的值</span>
<span class="sd">        :param l:</span>
<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">l</span><span class="p">:</span> <span class="k">return</span> <span class="kc">None</span>
        <span class="nb">sum</span> <span class="o">=</span> <span class="n">l</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">l</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">n</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span> <span class="k">raise</span> <span class="ne">InterruptedError</span><span class="p">(</span><span class="s2">&quot;列表个数不为奇数&quot;</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="mi">2</span><span class="p">):</span>
                <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">                从1开始，步长为2，每次应该都要取到函数</span>
<span class="sd">                &quot;&quot;&quot;</span>
                <span class="n">op</span> <span class="o">=</span> <span class="n">l</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                <span class="n">operand2</span> <span class="o">=</span> <span class="n">l</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>
                <span class="nb">sum</span> <span class="o">=</span> <span class="n">op</span><span class="p">(</span><span class="nb">sum</span><span class="p">,</span> <span class="n">operand2</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
            <span class="c1"># 出现字符串加数字等类型错误</span>
            <span class="k">raise</span> <span class="n">SamoyedTypeError</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2">和</span><span class="si">{}</span><span class="s2">无法做</span><span class="si">{}</span><span class="s2">运算&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="p">(</span><span class="nb">sum</span><span class="p">),</span> <span class="nb">type</span><span class="p">(</span><span class="n">operand2</span><span class="p">),</span> <span class="n">op</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">SamoyedRuntimeError</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="fm">__str__</span><span class="p">())</span>
        <span class="k">return</span> <span class="nb">sum</span></div>

    <span class="k">def</span> <span class="nf">_match_value</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value1</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="nb">bool</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="nb">str</span><span class="p">],</span>
                     <span class="n">value2</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="nb">bool</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">Pattern</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">bool</span><span class="p">,</span> <span class="n">Union</span><span class="p">[</span><span class="n">re</span><span class="o">.</span><span class="n">Match</span><span class="p">,</span> <span class="kc">None</span><span class="p">]]:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        判断节点的值是否匹配</span>
<span class="sd">        如果是正则匹配会返回匹配结果</span>
<span class="sd">        :param node:</span>
<span class="sd">        :param value1:</span>
<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">value1</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">value2</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="k">return</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">value1</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">value2</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="k">return</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value2</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">Pattern</span><span class="p">):</span>
            <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            如果node是正则表达式</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">value2</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">value1</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">result</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span> <span class="n">result</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            否则，先计算出值，直接进行值的比较</span>
<span class="sd">            如果两个对象都是字符串，value2只要是value1的子串即可</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value1</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value2</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                <span class="k">return</span> <span class="n">value1</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">value2</span><span class="p">)</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="kc">None</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">value1</span> <span class="o">==</span> <span class="n">value2</span><span class="p">,</span> <span class="kc">None</span>

    <span class="n">compare_operator</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;&gt;&quot;</span><span class="p">:</span> <span class="n">gt</span><span class="p">,</span>
        <span class="s2">&quot;&lt;&quot;</span><span class="p">:</span> <span class="n">lt</span><span class="p">,</span>
        <span class="s2">&quot;&gt;=&quot;</span><span class="p">:</span> <span class="n">ge</span><span class="p">,</span>
        <span class="s2">&quot;&lt;=&quot;</span><span class="p">:</span> <span class="n">le</span><span class="p">,</span>
        <span class="s2">&quot;==&quot;</span><span class="p">:</span> <span class="n">eq</span><span class="p">,</span>
        <span class="s2">&quot;!=&quot;</span><span class="p">:</span> <span class="n">ne</span><span class="p">,</span>
    <span class="p">}</span>
    <span class="n">arith_operator</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;+&quot;</span><span class="p">:</span> <span class="n">mock_add</span><span class="p">,</span>
        <span class="s2">&quot;-&quot;</span><span class="p">:</span> <span class="n">sub</span><span class="p">,</span>
        <span class="s2">&quot;*&quot;</span><span class="p">:</span> <span class="n">mul</span><span class="p">,</span>
        <span class="s2">&quot;/&quot;</span><span class="p">:</span> <span class="n">truediv</span><span class="p">,</span>
        <span class="s2">&quot;//&quot;</span><span class="p">:</span> <span class="n">floordiv</span><span class="p">,</span>
        <span class="s2">&quot;%&quot;</span><span class="p">:</span> <span class="n">mod</span>
    <span class="p">}</span></div>


<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2">/compile_template.py&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="vm">__file__</span><span class="p">))))</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
    <span class="n">template</span> <span class="o">=</span> <span class="n">file</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>


<div class="viewcode-block" id="compile"><a class="viewcode-back" href="../../source/samoyed.html#samoyed.core.compile">[文档]</a><span class="k">def</span> <span class="nf">compile</span><span class="p">(</span><span class="n">code</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">output_file</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
    <span class="n">i</span> <span class="o">=</span> <span class="n">Interpreter</span><span class="p">(</span><span class="n">code</span><span class="p">)</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">output_file</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
        <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">template</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">pos_arg</span><span class="o">=</span><span class="n">i</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">seq_args</span><span class="p">,</span>
                                   <span class="n">option_arg</span><span class="o">=</span><span class="n">i</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">option_args</span><span class="p">,</span>
                                   <span class="n">ast</span><span class="o">=</span><span class="n">i</span><span class="o">.</span><span class="n">ast</span><span class="p">))</span></div>
</pre></div>

          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../../index.html">samoyed</a></h1>








<h3>导航</h3>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../index.html">Documentation overview</a><ul>
  <li><a href="../index.html">模块代码</a><ul>
  </ul></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">快速搜索</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="转向" />
    </form>
    </div>
</div>
<script>$('#searchbox').show(0);</script>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2021, ruiqurm.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 4.3.1</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.12</a>
      
    </div>

    

    
  </body>
</html>